<!DOCTYPE html>
<html lang="KO">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Avoid Boxes</title>

        <link rel="stylesheet" href="css/style.css">
    </head>
    <body>
        <button id="themeToggle" class="theme-toggle" aria-label="Toggle theme">Dark</button>
        <button id="soundToggle" class="sound-toggle" aria-label="Toggle sound" title="ì‚¬ìš´ë“œ ë„ê¸°">ğŸ”Š</button>
        <div id="startMenu" class="start-menu">
                <div class="menu-content">
                    <h1 class="game-title">Avoid Boxes</h1>
                    <div class="menu-stats">
                        <div class="menu-stat-item">
                            <span class="menu-stat-label">ìµœê³  ì ìˆ˜</span>
                            <span id="menuBestScore" class="menu-stat-value">0</span>
                        </div>
                        <div class="menu-stat-item">
                            <span class="menu-stat-label">ìµœê³  ì‹œê°„</span>
                            <span id="menuBestTime" class="menu-stat-value">0ì´ˆ</span>
                        </div>
                        <div class="menu-stat-item">
                            <span class="menu-stat-label">ìµœê³  ì½¤ë³´</span>
                            <span id="menuBestCombo" class="menu-stat-value">0x</span>
                        </div>
                    </div>
                    <div class="speed-selector">
                        <label>ê²Œì„ ì†ë„:</label>
                        <select id="speedSelect" class="speed-select">
                            <option value="0.75">ëŠë¦¼</option>
                            <option value="1.0" selected>ë³´í†µ</option>
                            <option value="1.5">ë¹ ë¦„</option>
                        </select>
                    </div>
                    <div class="player-color-selector">
                        <label>í”Œë ˆì´ì–´ ìƒ‰ìƒ:</label>
                        <select id="playerColorSelect" class="player-color-select">
                            <option value="">ìë™ (í…Œë§ˆì— ë”°ë¼)</option>
                            <option value="#ff4444">ë¹¨ê°•</option>
                            <option value="#4444ff">íŒŒë‘</option>
                            <option value="#44ff44">ì´ˆë¡</option>
                            <option value="#ffff44">ë…¸ë‘</option>
                            <option value="#ff44ff">ë³´ë¼</option>
                            <option value="#44ffff">ì²­ë¡</option>
                            <option value="#ff8844">ì£¼í™©</option>
                        </select>
                    </div>
                    <button id="startBtn" class="start-btn">ê²Œì„ ì‹œì‘</button>
                    <button id="achievementsBtn" class="achievements-btn">ì—…ì  ë³´ê¸°</button>
                    <div id="achievementsModal" class="achievements-modal" style="display:none;">
                        <div class="achievements-content">
                            <h2>ì—…ì </h2>
                            <div id="achievementsList" class="achievements-list"></div>
                            <button class="close-achievements">ë‹«ê¸°</button>
                        </div>
                    </div>
                    <div class="controls-info">
                        <h3>ì¡°ì‘ë²•</h3>
                        <div class="control-item">
                            <kbd>â†</kbd> <kbd>â†’</kbd> <span>ì´ë™</span>
                        </div>
                        <div class="control-item">
                            <kbd>Space</kbd> <span>ìˆ¨ê¸° ìŠ¤í‚¬</span>
                        </div>
                        <div class="control-item">
                            <kbd>Q</kbd> <span>ë¬´ì  ìŠ¤í‚¬ (ì•„ì´í…œ í•„ìš”)</span>
                        </div>
                        <div class="control-item">
                            <kbd>W</kbd> <span>ì†Œí˜•í™” ìŠ¤í‚¬ (ì•„ì´í…œ í•„ìš”)</span>
                        </div>
                        <div class="control-item">
                            <kbd>E</kbd> <span>ìŠ¬ë¡œìš° ëª¨ì…˜ ìŠ¤í‚¬ (ì•„ì´í…œ í•„ìš”)</span>
                        </div>
                        <div class="control-item">
                            <kbd>ESC</kbd> <span>ì¼ì‹œì •ì§€</span>
                        </div>
                        <div class="control-item">
                            <kbd>P</kbd> <span>ì¬ì‹œì‘ (ê²Œì„ ì˜¤ë²„ í›„)</span>
                        </div>
                    </div>
                </div>
            </div>
        <div class="game-wrap">
            <div class="canvas-container">
                <canvas id="gameCanvas" width="800" height="600"></canvas>
                <div id="pauseOverlay" class="pause-overlay" style="display:none;">
                    <div class="pause-content">
                        <h2>ì¼ì‹œì •ì§€</h2>
                        <p>ESC í‚¤ë¥¼ ëˆŒëŸ¬ ì¬ê°œí•˜ì„¸ìš”</p>
                    </div>
                </div>
            </div>
            <aside id="itemHud" class="item-hud" style="display:none;">
                <div id="livesHud" class="lives-hud" aria-label="Lives"></div>
                <div id="statsDisplay" class="stats-display"></div>
                <div class="ability-bar">
                    <div class="slot" id="slot-hide" data-total="15000">
                        <div class="icon">
                            <svg viewBox="0 0 64 64" aria-hidden="true">
                                <defs>
                                    <linearGradient id="g-hide" x1="0" y1="0" x2="1" y2="1">
                                        <stop offset="0" stop-color="#bdbdbd"/>
                                        <stop offset="1" stop-color="#616161"/>
                                    </linearGradient>
                                </defs>
                                <rect width="64" height="64" fill="url(#g-hide)"/>
                                <path d="M32 14a14 14 0 1 0 0 28 16 16 0 1 1 0-28z" fill="#fff" fill-opacity="0.9"/>
                            </svg>
                            <div class="cool-overlay"><div class="pie"></div><span class="remain"></span></div>
                        </div>
                        <div class="count" style="display:none;">0</div>
                        <div class="skill-name">ìˆ¨ê¸°</div>
                        <div class="key">Space</div>
                        <div class="meta"><span class="dur"></span> / <span class="cd-total"></span></div>
                    </div>
                    <div class="slot" id="slot-inv" data-total="60000">
                        <div class="icon">
                            <svg viewBox="0 0 64 64" aria-hidden="true">
                                <defs>
                                    <linearGradient id="g-inv" x1="0" y1="0" x2="1" y2="1">
                                        <stop offset="0" stop-color="#26c6da"/>
                                        <stop offset="1" stop-color="#0097a7"/>
                                    </linearGradient>
                                </defs>
                                <rect width="64" height="64" fill="url(#g-inv)"/>
                                <path d="M32 10l18 8v12c0 10-7.5 18.7-18 22-10.5-3.3-18-12-18-22V18l18-8z" fill="#fff" fill-opacity="0.9"/>
                            </svg>
                            <div class="cool-overlay"><div class="pie"></div><span class="remain"></span></div>
                        </div>
                        <div class="count">0</div>
                        <div class="skill-name">ë¬´ì </div>
                        <div class="key">Q</div>
                        <div class="meta"><span class="dur"></span> / <span class="cd-total"></span></div>
                    </div>
                    <div class="slot" id="slot-shr" data-total="45000">
                        <div class="icon">
                            <svg viewBox="0 0 64 64" aria-hidden="true">
                                <defs>
                                    <linearGradient id="g-shr" x1="0" y1="0" x2="1" y2="1">
                                        <stop offset="0" stop-color="#9ccc65"/>
                                        <stop offset="1" stop-color="#558b2f"/>
                                    </linearGradient>
                                </defs>
                                <rect width="64" height="64" fill="url(#g-shr)"/>
                                <path d="M20 20h10v-8l12 12-12 12v-8H20V20zm24 24H34v8L22 40l12-12v8h10v8z" fill="#fff" fill-opacity="0.9"/>
                            </svg>
                            <div class="cool-overlay"><div class="pie"></div><span class="remain"></span></div>
                        </div>
                        <div class="count">0</div>
                        <div class="skill-name">ì†Œí˜•í™”</div>
                        <div class="key">W</div>
                        <div class="meta"><span class="dur"></span> / <span class="cd-total"></span></div>
                    </div>
                    <div class="slot" id="slot-slow" data-total="30000">
                        <div class="icon">
                            <svg viewBox="0 0 64 64" aria-hidden="true">
                                <defs>
                                    <linearGradient id="g-slow" x1="0" y1="0" x2="1" y2="1">
                                        <stop offset="0" stop-color="#9c27b0"/>
                                        <stop offset="1" stop-color="#6a1b9a"/>
                                    </linearGradient>
                                </defs>
                                <rect width="64" height="64" fill="url(#g-slow)"/>
                                <circle cx="32" cy="32" r="14" fill="none" stroke="#fff" stroke-width="2" stroke-opacity="0.9"/>
                                <line x1="32" y1="18" x2="32" y2="26" stroke="#fff" stroke-width="2" stroke-opacity="0.9" stroke-linecap="round"/>
                                <line x1="32" y1="32" x2="38" y2="32" stroke="#fff" stroke-width="2" stroke-opacity="0.9" stroke-linecap="round"/>
                            </svg>
                            <div class="cool-overlay"><div class="pie"></div><span class="remain"></span></div>
                        </div>
                        <div class="count">0</div>
                        <div class="skill-name">ìŠ¬ë¡œìš°</div>
                        <div class="key">E</div>
                        <div class="meta"><span class="dur"></span> / <span class="cd-total"></span></div>
                    </div>
                </div>
                <div class="game-controls">
                    <button id="restartBtn" class="restart-btn">ì¬ì‹œì‘ (P)</button>
                </div>
            </aside>
        </div>
        <script src="js/avoid_boxes.js"></script>
        <script>
            // ì´ˆê¸°í™” í•¨ìˆ˜
            function initializeSelectors() {
                console.log('ì´ˆê¸°í™” ì‹œì‘');
                
                // ê²Œì„ ì†ë„ ì„ íƒê¸° ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
                const speedSelect = document.getElementById('speedSelect');
                console.log('speedSelect ìš”ì†Œ:', speedSelect);
                if (speedSelect) {
                    // ì €ì¥ëœ ê²Œì„ ì†ë„ ë¶ˆëŸ¬ì˜¤ê¸°
                    const savedSpeed = localStorage.getItem('ab_gameSpeed');
                    if (savedSpeed) {
                        speedSelect.value = savedSpeed;
                        console.log('ì €ì¥ëœ ê²Œì„ ì†ë„ ë¶ˆëŸ¬ì˜¤ê¸°:', savedSpeed);
                    }
                    
                    // ê²Œì„ ì†ë„ ë³€ê²½ ì‹œ ì €ì¥ ë° ì¦‰ì‹œ ë°˜ì˜
                    // ê¸°ì¡´ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì œê±°ë¥¼ ìœ„í•´ ìƒˆë¡œ ì¶”ê°€
                    speedSelect.addEventListener('change', function() {
                        const selectedSpeed = this.value;
                        console.log('ê²Œì„ ì†ë„ ë³€ê²½ ì´ë²¤íŠ¸ ë°œìƒ:', selectedSpeed);
                        localStorage.setItem('ab_gameSpeed', selectedSpeed);
                        // avoid_boxes.jsì˜ ì „ì—­ ë³€ìˆ˜ gameSpeed ì—…ë°ì´íŠ¸
                        if (typeof gameSpeed !== 'undefined') {
                            gameSpeed = parseFloat(selectedSpeed);
                            console.log('ê²Œì„ ì†ë„ ë³€ìˆ˜ ì—…ë°ì´íŠ¸:', gameSpeed);
                        }
                        console.log('ê²Œì„ ì†ë„ ì €ì¥ ì™„ë£Œ:', selectedSpeed);
                    }, { once: false });
                    
                    // input ì´ë²¤íŠ¸ë„ ì¶”ê°€ (ì¼ë¶€ ë¸Œë¼ìš°ì € ëŒ€ì‘)
                    speedSelect.addEventListener('input', function() {
                        const selectedSpeed = this.value;
                        localStorage.setItem('ab_gameSpeed', selectedSpeed);
                        if (typeof gameSpeed !== 'undefined') {
                            gameSpeed = parseFloat(selectedSpeed);
                        }
                    }, { once: false });
                } else {
                    console.error('speedSelect ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                }
                
                // í”Œë ˆì´ì–´ ìƒ‰ìƒ ì„ íƒê¸° ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
                const playerColorSelect = document.getElementById('playerColorSelect');
                console.log('playerColorSelect ìš”ì†Œ:', playerColorSelect);
                if (playerColorSelect) {
                    // ì €ì¥ëœ í”Œë ˆì´ì–´ ìƒ‰ìƒ ë¶ˆëŸ¬ì˜¤ê¸°
                    const savedColor = localStorage.getItem('ab_playerColor');
                    if (savedColor !== null) {
                        playerColorSelect.value = savedColor || '';
                        console.log('ì €ì¥ëœ í”Œë ˆì´ì–´ ìƒ‰ìƒ ë¶ˆëŸ¬ì˜¤ê¸°:', savedColor);
                    }
                    
                    // í”Œë ˆì´ì–´ ìƒ‰ìƒ ë³€ê²½ ì‹œ ì €ì¥ ë° ì¦‰ì‹œ ë°˜ì˜
                    // ê¸°ì¡´ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì œê±°ë¥¼ ìœ„í•´ ìƒˆë¡œ ì¶”ê°€
                    playerColorSelect.addEventListener('change', function() {
                        const colorValue = this.value || '';
                        console.log('í”Œë ˆì´ì–´ ìƒ‰ìƒ ë³€ê²½ ì´ë²¤íŠ¸ ë°œìƒ:', colorValue || 'ìë™');
                        localStorage.setItem('ab_playerColor', colorValue);
                        // avoid_boxes.jsì˜ ì „ì—­ ë³€ìˆ˜ player.color ì—…ë°ì´íŠ¸
                        if (typeof player !== 'undefined') {
                            player.color = colorValue || null;
                            console.log('í”Œë ˆì´ì–´ ìƒ‰ìƒ ë³€ìˆ˜ ì—…ë°ì´íŠ¸:', player.color);
                        }
                        console.log('í”Œë ˆì´ì–´ ìƒ‰ìƒ ì €ì¥ ì™„ë£Œ:', colorValue || 'ìë™');
                    }, { once: false });
                    
                    // input ì´ë²¤íŠ¸ë„ ì¶”ê°€ (ì¼ë¶€ ë¸Œë¼ìš°ì € ëŒ€ì‘)
                    playerColorSelect.addEventListener('input', function() {
                        const colorValue = this.value || '';
                        localStorage.setItem('ab_playerColor', colorValue);
                        if (typeof player !== 'undefined') {
                            player.color = colorValue || null;
                        }
                    }, { once: false });
                } else {
                    console.error('playerColorSelect ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                }
            }
            
            // DOMì´ ì™„ì „íˆ ë¡œë“œëœ í›„ ì‹¤í–‰
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', function() {
                    console.log('DOMContentLoaded ì´ë²¤íŠ¸ ë°œìƒ');
                    setTimeout(initializeSelectors, 100);
                });
            } else {
                console.log('DOMì´ ì´ë¯¸ ë¡œë“œë¨');
                setTimeout(initializeSelectors, 100);
            }
            
            // window.onloadë„ ì¶”ê°€ (ë” í™•ì‹¤í•˜ê²Œ)
            window.addEventListener('load', function() {
                console.log('window.onload ì´ë²¤íŠ¸ ë°œìƒ');
                setTimeout(initializeSelectors, 200);
            });
            
            // ê²Œì„ ì‹œì‘ ë²„íŠ¼
            const startBtn = document.getElementById('startBtn');
            if (startBtn) {
                startBtn.addEventListener('click', startGame);
            }
            
            // ì‚¬ìš´ë“œ í† ê¸€ ë²„íŠ¼
            const soundToggle = document.getElementById('soundToggle');
            if (soundToggle) {
                soundToggle.addEventListener('click', () => {
                    if (typeof toggleSound === 'function') {
                        toggleSound();
                    }
                });
            }
            
            // ì €ì¥ëœ ì‚¬ìš´ë“œ ì„¤ì • ë¶ˆëŸ¬ì˜¤ê¸°
            const savedSound = localStorage.getItem('ab_sound');
            if (savedSound === 'off') {
                soundEnabled = false;
                const soundBtn = document.getElementById('soundToggle');
                if (soundBtn) {
                    soundBtn.textContent = 'ğŸ”‡';
                    soundBtn.title = 'ì‚¬ìš´ë“œ ì¼œê¸°';
                }
            }
            
            // ì—…ì  ë²„íŠ¼
            const achievementsBtn = document.getElementById('achievementsBtn');
            if (achievementsBtn) {
                achievementsBtn.addEventListener('click', () => {
                    const modal = document.getElementById('achievementsModal');
                    if (modal) {
                        modal.style.display = 'flex';
                        updateAchievementsList();
                    }
                });
            }
            
            const closeAchievements = document.querySelector('.close-achievements');
            if (closeAchievements) {
                closeAchievements.addEventListener('click', () => {
                    const modal = document.getElementById('achievementsModal');
                    if (modal) {
                        modal.style.display = 'none';
                    }
                });
            }
            
            function updateAchievementsList() {
                const list = document.getElementById('achievementsList');
                const unlocked = typeof getUnlockedAchievements === 'function' ? getUnlockedAchievements() : [];
                if (typeof achievements !== 'undefined') {
                    list.innerHTML = achievements.map(ach => {
                        const isUnlocked = unlocked.includes(ach.id);
                        return `
                            <div class="achievement-item ${isUnlocked ? 'unlocked' : 'locked'}">
                                <div class="achievement-icon">${isUnlocked ? 'ğŸ†' : 'ğŸ”’'}</div>
                                <div class="achievement-info">
                                    <div class="achievement-name">${ach.name}</div>
                                    <div class="achievement-desc">${ach.desc}</div>
                                </div>
                                ${isUnlocked ? '<div class="achievement-status">ë‹¬ì„±</div>' : ''}
                            </div>
                        `;
                    }).join('');
                }
            }
            
            // ì¬ì‹œì‘ ë²„íŠ¼
            const restartBtn = document.getElementById('restartBtn');
            if (restartBtn) {
                restartBtn.addEventListener('click', resetGame);
            }
            
            document.addEventListener('keydown', function(e) {
                if ((e.key === 'p' || e.key === 'P') && typeof gameOver !== 'undefined' && gameOver) {
                    e.preventDefault();
                    resetGame();
                }
            });
            
            // í†µê³„ í‘œì‹œ ì—…ë°ì´íŠ¸
            function updateStatsDisplay() {
                if (typeof getStats === 'function') {
                    const stats = getStats();
                    const display = document.getElementById('statsDisplay');
                    if (display) {
                        display.innerHTML = `
                            <div class="stat-item">
                                <span class="stat-label">ìµœê³  ì ìˆ˜:</span>
                                <span class="stat-value">${(stats.bestScore || 0).toLocaleString()}</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-label">ìµœê³  ì‹œê°„:</span>
                                <span class="stat-value">${(stats.bestTime || 0).toFixed(1)}ì´ˆ</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-label">ìµœê³  ì½¤ë³´:</span>
                                <span class="stat-value">${stats.bestCombo || 0}x</span>
                            </div>
                        `;
                    }
                }
            }
            setInterval(updateStatsDisplay, 1000);
            updateStatsDisplay();
            
            // ë©”ë‰´ í†µê³„ë„ ì£¼ê¸°ì ìœ¼ë¡œ ì—…ë°ì´íŠ¸
            setInterval(() => {
                if (typeof updateMenuStats === 'function') {
                    updateMenuStats();
                }
            }, 1000);
        </script>
    </body>
</html>